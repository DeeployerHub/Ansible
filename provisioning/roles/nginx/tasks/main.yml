---
- name: Check nginx installed
  apt: name=nginx state=latest

- name: Start nginx
  service:
    name: nginx
    state: started

- name: Install nginx-extras
  apt: pkg=nginx-extras state=present
  become: yes

- name: copy nginx config
  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
  notify:
    - reload nginx

- name: add hosts
  template: src={{item.nginx_template | default('nginx-vhost.j2')}} dest=/etc/nginx/sites-available/{{ item.domain_name }}
  with_items: hosts
  notify:
    - reload nginx

- name: add host to enabled
  file: src=/etc/nginx/sites-available/{{item.domain_name}} dest=/etc/nginx/sites-enabled/{{item.domain_name}} state=link
  with_items: hosts
  notify:
    - reload nginx

- name: Disable the default site
  file: path=/etc/nginx/sites-enabled/default state=absent
  notify:
  - reload nginx
  tags: [configuration,nginx]

- name: Remove the default configuration
  file: path=/etc/nginx/sites-available/default state=absent
  notify:
  - reload nginx
  tags: [configuration,nginx]